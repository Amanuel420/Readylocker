{% extends 'base.html' %}

{% block title %}Ready Locker - Find a Location{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<section class="relative py-12 bg-gradient-to-b from-white to-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-10">
      <h1 class="text-4xl sm:text-5xl font-bold mb-4 text-gray-900">
        Find a Locker <span class="text-primary">Near You.</span>
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Click a red dot on the map to book a locker at that location.
      </p>
    </div>

    <div class="w-full h-[600px] shadow-2xl rounded-2xl overflow-hidden border border-gray-200 relative z-0">
      <div id="hero-map" class="h-full w-full" style="min-height: 600px;"></div>
    </div>
  </div>
</section>

<section class="py-12 bg-white border-b border-gray-200">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <form method="GET" action="{% url 'home' %}" class="flex flex-col sm:flex-row gap-3">
      <input type="search" name="search" placeholder="Search by city, state or zip..." value="{{ search_query|default:'' }}" class="flex-1 px-6 py-4 bg-white border-2 border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"/>
      <button type="submit" class="bg-primary hover:bg-red-700 text-white px-8 py-4 rounded-lg font-semibold transition-colors shadow-lg">Search Locations</button>
    </form>
  </div>
</section>

<section id="locations" class="py-16 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="text-3xl font-bold mb-12 text-center text-gray-900">Available Locations</h2>
    {% if locations %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for loc in locations %}
          <div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-xl transition-all">
            {% if loc.image %}
              <div class="mb-4 h-48 rounded-lg overflow-hidden">
                <img src="{{ loc.image.url }}" alt="{{ loc.name }}" class="w-full h-full object-cover">
              </div>
            {% endif %}
            <h3 class="text-xl font-bold mb-2 text-primary">{{ loc.name }}</h3>
            <p class="text-gray-600 mb-4 text-sm">{{ loc.address }}</p>
            <a href="{% url 'location_detail' loc.id %}" class="block w-full bg-white border-2 border-primary text-primary hover:bg-primary hover:text-white text-center px-6 py-3 rounded-lg font-semibold transition-colors">View Available Sizes</a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-16">
        <p class="text-gray-600 text-lg mb-4">No locations found.</p>
        <a href="{% url 'home' %}" class="text-primary hover:text-red-600 underline">View all locations</a>
      </div>
    {% endif %}
  </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

{{ map_data|json_script:"locations-data" }}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialize Map
    var map = L.map('hero-map').setView([39.09, -77.04], 10); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; OpenStreetMap contributors'}).addTo(map);

    // 2. Read the data from the script tag
    var dataElement = document.getElementById('locations-data');
    if (!dataElement) {
        console.error("Error: Could not find locations data element.");
        return;
    }
    
    var locationsData = JSON.parse(dataElement.textContent);
    console.log("Loaded Locations:", locationsData); // Check console if map is still empty

    var markers = [];

    // 3. Add Markers
    if (locationsData && locationsData.length > 0) {
        locationsData.forEach(function(loc) {
            if(loc.lat && loc.lng && (loc.lat !== 0 || loc.lng !== 0)) {
                
                // Red Dot
                var marker = L.circleMarker([loc.lat, loc.lng], {
                    radius: 10,
                    fillColor: "#c62828",
                    color: "#ffffff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                var popupContent = `
                  <div class="text-center p-2">
                    <h3 class="font-bold text-lg mb-1">${loc.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${loc.address}</p>
                    <a href="/location/${loc.id}/" class="inline-block bg-red-700 text-white px-4 py-2 rounded text-sm font-bold no-underline hover:bg-red-800">Rent Here</a>
                  </div>
                `;
                marker.bindPopup(popupContent);
                markers.push(marker);
            }
        });
        
        // 4. Auto-zoom
        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
  });
</script>
{% endblock %}